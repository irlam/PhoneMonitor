name: Android Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'android/**'
      - '.github/workflows/android-build.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'android/**'

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: |
        cd android
        chmod +x gradlew || echo "gradlew not found, creating wrapper"
        if [ ! -f "gradlew" ]; then
          echo "Gradle wrapper will be generated by first build"
        fi

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build debug APK
      run: |
        cd android
        if [ -f "gradlew" ]; then
          ./gradlew assembleDebug --stacktrace
        else
          gradle wrapper
          ./gradlew assembleDebug --stacktrace
        fi

    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: app-debug
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    - name: Run lint
      run: |
        cd android
        if [ -f "gradlew" ]; then
          ./gradlew lint || echo "Lint completed with warnings"
        fi

    - name: Upload lint report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: lint-report
        path: android/app/build/reports/lint-results-debug.html
        if-no-files-found: ignore

  codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: java-kotlin
        queries: security-and-quality

    - name: Build for CodeQL
      run: |
        cd android
        if [ -f "gradlew" ]; then
          chmod +x gradlew
          ./gradlew assembleDebug
        else
          gradle wrapper
          ./gradlew assembleDebug
        fi

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
