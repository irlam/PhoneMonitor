name: PHP CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.php'
      - 'composer.json'
      - '.github/workflows/php-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.php'
      - 'composer.json'

jobs:
  php-ci:
    name: PHP Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, pdo, pdo_mysql
          coverage: none
      
      - name: Validate PHP files
        run: |
          echo "Validating PHP syntax..."
          find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
      
      - name: Check for security issues
        run: |
          echo "Checking for common security issues..."
          # Check for eval() usage
          if grep -r "eval(" --include="*.php" --exclude-dir=vendor .; then
            echo "Warning: eval() found in code"
          fi
          # Check for exposed phpinfo()
          if grep -r "phpinfo()" --include="*.php" --exclude-dir=vendor .; then
            echo "Warning: phpinfo() found in code"
          fi
          echo "Basic security checks completed"
      
      - name: Check file permissions
        run: |
          echo "Checking for sensitive files..."
          if [ -f ".env" ]; then
            echo "Warning: .env file should not be committed"
            exit 1
          fi
          echo "File permission checks completed"
  
  codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'javascript'
          queries: security-and-quality
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
